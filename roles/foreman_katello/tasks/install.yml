---
- name: Pre-flight - Verify Pulp storage is mounted
  assert:
    that:
      - ansible_mounts | selectattr('mount', 'equalto', foreman_pulp_mount) | list | length > 0
    fail_msg: "Pulp storage is not mounted at {{ foreman_pulp_mount }}."

- name: Ensure the parameterized temp directory exists
  file:
    path: "{{ safe_tmp_dir }}"
    state: directory
    mode: '0700'

name: Download release RPMs (Foreman, Katello, Puppet)
  get_url:
    url: "{{ item }}"
    dest: "{{ safe_tmp_dir }}/{{ item | basename }}"
    mode: '0644'
  loop:
    - "{{ foreman_repo_url }}"
    - "{{ katello_repo_url }}"
    - "{{ puppet_repo_url }}"

- name: Install release packages from local path
  dnf:
    name:
      - "{{ safe_tmp_dir }}/{{ foreman_repo_url | basename }}"
      - "{{ safe_tmp_dir }}/{{ katello_repo_url | basename }}"
      - "{{ safe_tmp_dir }}/{{ puppet_repo_url | basename }}"
    state: present
    disable_gpg_check: yes
  environment:
    TMPDIR: "{{ safe_tmp_dir }}"

- name: Install Foreman/Katello installer packages
  dnf:
    name:
      - foreman-installer
      - katello
      - puppet-agent
      - rubygem-kafo
    state: present
  environment:
    TMPDIR: "{{ safe_tmp_dir }}"

- name: Ensure installer configuration directory exists
  file:
    path: /etc/foreman-installer/scenarios.d
    state: directory
    mode: '0750'

- name: Deploy Katello answers file from template
  template:
    src: katello-answers.j2
    dest: /etc/foreman-installer/scenarios.d/katello-answers.yaml
    mode: '0640'

- name: Run Foreman-Katello Installer
  command: >
    foreman-installer --scenario katello
    --answers-file /etc/foreman-installer/scenarios.d/katello-answers.yaml
  args:
    creates: /etc/foreman/settings.yaml
  register: installer_output
  failed_when: "'Main Step: Success' not in installer_output.stdout"
  environment:
    PATH: "/sbin:/bin:/usr/sbin:/usr/bin:/opt/puppetlabs/bin"
    TERM: xterm-256color
  failed_when: "'Main Step: Success' not in installer_output.stdout"